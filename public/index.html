<html>

<head>

<title>PetrolSpy</title>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular-sanitize.js"></script>


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<link href="https://bootswatch.com/flatly/bootstrap.min.css" rel="stylesheet">

<script src="js/moment.js"></script>

<script src="js/leaflet.js"></script>
<link href="css/leaflet.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.7.0/bootstrap-slider.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.7.0/css/bootstrap-slider.min.css" rel="stylesheet">

<!-- charts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>


</head>


<style>

#map { 
	height: 100%;
	width: 100%;
}

.no-padding {
	padding:0;
}

.animate-show {
  opacity: 1;
}

.animate-show.ng-hide-add, .animate-show.ng-hide-remove {
  transition: all linear 0.5s;
}

.animate-show.ng-hide {
  opacity: 0;
}

.container {
	padding-top:10px;
}

.full {
height:100%;
width: 100%;
overflow:hidden !important;
}


</style>

<body class="full">

<div class="container-fluid no-padding full" ng-app="app" ng-controller="ctrl">

	<div ng-if="true" class="row well" style="position:absolute; right:0; z-index:3">
		<button ng-click="clearLog()">clear</button>
		<pre>{{values.log | json }}</pre>
	</div>
	
	<div class="row" style="width:100%;position:absolute; z-index:2">
		<div class="text-center">
			<button type="button" class="btn btn-default" style="font-size:35px!important">
				{{min}} - {{med}} - {{max}}
			</button>
		</div>
	</div>
	
	<div class="row" ng-show="values.data" style="position:absolute; z-index:2">
		<div class="col-md-offset-4 col-md-4">
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size:35px!important">
                    {{values.type}} <span class="caret"></span>
                </button>
                
                <ul class="dropdown-menu">
                    <li ng-repeat="t in values.types | orderBy:t" 
					    ng-click="selectType(t)"><a href="javascript:void(0)">{{t}}</a></li>
                </ul>
            </div>
		</div>
	</div>
    
	<div id="map" style="z-index:1"></div>
	
</div>

<script>

var app = angular.module('app', ['ngSanitize']);

app.factory('gps', ['$q', '$window', function ($q, $window) {
    function getCurrentPosition() {
        var deferred = $q.defer();

        if (!$window.navigator.geolocation) {
			console.log('Geolocation not supported.');
            deferred.reject('Geolocation not supported.');
        } else {
            $window.navigator.geolocation.getCurrentPosition(
                function (position) {
                    deferred.resolve(position);
                },
                function (err) {
					console.log(err);
                    deferred.reject(err);
                });
        }

        return deferred.promise;
    }

    return {
        getPosition: getCurrentPosition
    };
}]);

app.factory('prices', function($http) { 
    return $http.get('/petrol');
});


app.controller("ctrl", ["$scope", "$http", "$interval", "gps", "prices", function($scope, $http, $interval, gps, prices) {

	var getDistanceFromLatLonInKm = function (lat1,lon1,lat2,lon2) {
		var R = 6371; // Radius of the earth in km
		var dLat = deg2rad(lat2-lat1);  // deg2rad below
		var dLon = deg2rad(lon2-lon1); 
		var a = 
			Math.sin(dLat/2) * Math.sin(dLat/2) +
			Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
			Math.sin(dLon/2) * Math.sin(dLon/2); 
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
		var d = R * c; // Distance in km
		return d;
	};
    
    var deg2rad = function (deg) {
		return deg * (Math.PI/180)
	};
    
    var Icon = L.Icon.extend({
        options: {
            iconSize:     [32, 32],
            shadowSize:   [0, 0],
            iconAnchor:   [32, 32],
            shadowAnchor: [0, 0],
            popupAnchor:  [-3, -32]
        }
    });
	
	var ageToTime = function(timestamp) {
		return moment.duration(timestamp).humanize();
	};

    var gmap = function(lat, lon) {
        return "https://www.google.com/maps?q="+lat+","+lon;
    };
	
	var addLog = function(l) {
		if ($scope.values.log) 
			$scope.values.log.push(l);
	};
	
	$scope.clearLog = function() { 
		$scope.values.log = [];
	};
	
	$scope.initMap = function(data) {
		addLog('initMap');
	
		addLog('reset map');
		$('#map_parent').empty();
		
		addLog('load map');
		$('#map_parent').append($('<div id="map"></div>'));
		
		addLog('set map size');
		$('#map').width($('#map_parent').width());
		$('#map').height($('#map_parent').height());
		$('#map').css('background-color','white');
		
		addLog('set map to adelaide');
		var pos = [$scope.values.location.adelaide.lat, $scope.values.location.adelaide.lat];
		var zoom = 14;
		
		// extend the map for the nearest petrol station
		// TODO: maybe we want the nearest cheapest?
		
		// set the view of the map
		$scope.values.map = L.map('map', {zoomControl:false}).setView(pos, zoom);
		
		addLog('add map tiles');
		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			attribution: 'Rhys Lohf & PetrolSpy'
		}).addTo($scope.values.map);
		
		addLog('add markers');
		addMarkers(data);
	};
	
	var addMarkers = function(data) {
		addLog('remove existing petrol station markers');
		angular.forEach($scope.values.markers, function(obj,key) {
			$scope.removeMarker($scope.values.map, obj);
		});
		
		addLog('add new relevant petrol station markers');
		angular.forEach(data, function(obj, key) {
		
			// skip if !type
			if (obj.type != $scope.values.type) return true;
		
			// prepare string for on click
			var asOf = '(as of ' + (ageToTime(obj.age)) + ' ago)';
			var clickString = obj.price + ' ' + asOf;
			
			// create/add marker
			var marker = $scope.addMarker($scope.values.map, obj.location.lat, obj.location.lon, clickString, obj.icon);
			
			// store type on the marker
			marker.type = obj.type;
			
			// keep it
			$scope.values.markers.push(marker);
		});
	};
	
	$scope.addMarker = function(map, lat, lon, clickString, icon) {
		if (map && lat && lon) {
			if (icon) {
				var i = L.Icon.extend({
					options: {
						iconUrl: 'img/'+icon,
						iconSize:     [32, 32],
						popupAnchor:  [-0, -15]
					}
				});
				
				var marker = L.marker([lat, lon], {icon: new i}).addTo(map).bindPopup(clickString);
				return marker;
			} else {
				var marker = L.marker([lat, lon]).addTo(map).bindPopup(clickString);
				return marker;
			}
		}
	};
	
	$scope.removeMarker = function(map, marker) {
		map.removeLayer(marker);
	};
	
	$scope.selectType = function(t) { 
		$scope.values.type = t;
	};
	
	var loadPrices = function(data) {
		addLog('received data');
		$scope.values.data = data.data;
		
		angular.forEach(data.data, function(key, value) {
			if ($scope.values.types.indexOf(key.type) == -1) {
				$scope.values.types.push(key.type);
			}
		});
		
		// default selected type
		$scope.values.type = $scope.values.types[0];
		
		// initialise the map
		$scope.initMap($scope.data);

	};
	
	var loadLocation = function() {
		// get my location
		gps.getPosition().then(function(data) {

			$scope.values.location.my = {
				lat: data.coords.latitude,
				lon: data.coords.longitude
			};
			
		});
	};
	
	var panMapTo = function(map, location) {
		map.panTo(new L.LatLng(location.lat, location.lon));
	};
	
	// watch for my location being set
	$scope.$watch('values.location.my', function() {
		if ($scope.values.location.my) {
			addLog('values.location.my changed');

			if ($scope.map) {
			
				addLog('.. and map exists');
				
				addLog('panning map to my location');
				panMapTo($scope.map, $scope.values.location.my);
				
				//TODO:
				// extend the map with my location and the next cheapest?
			}
		}
	});
	
	$scope.$watch('values.map', function() {
		if ($scope.values.map) {
			addLog('values.map changed');
			addLog('panning map to adelaide');
			panMapTo($scope.values.map, $scope.values.location.adelaide)
		}
	});
	
	$scope.$watch('values.type', function() {
		if ($scope.values.type) {
			addLog('values.type changed');
			
			addMarkers($scope.values.data);
		}
	});
	
	// storages
	$scope.values = {};
	
	$scope.values.log = [];
	
	// adelaide lat lon
	$scope.values.location = {};
	$scope.values.location.adelaide = {
		lat: -34.9285,
		lon: 138.6007
	};
	
	$scope.values.location.my = null;
	
	// default zoom
	$scope.values.zoom = 13;
	
	// TODO: might not need this anymore
	// default max radius (in km)
	$scope.values.max_radius = 5;
	
	// markers storage
	$scope.values.markers = [];
	
	// type of petrol storage
	$scope.values.types = [];
	
	// load prices
	prices.then(loadPrices);
	
}]);

</script>